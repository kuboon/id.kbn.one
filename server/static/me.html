<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>kbn.one ID central</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="page">
      <header class="page-header">
        <div class="brand">
          <h1 id="brand">kbn.one ID central</h1>
        </div>
      </header>

      <section id="account-view" class="panel" hidden>
        <div class="card">
          <header class="section-header">
            <div>
              <h2>プロフィール情報</h2>
              <p class="hint" id="account-summary">
                サインイン中のユーザー情報が表示されます。
              </p>
            </div>
            <div class="section-actions">
              <button type="button" id="logout" class="secondary">
                ログアウト
              </button>
              <button type="button" id="delete-account" class="danger">
                アカウントを削除
              </button>
            </div>
          </header>
          <form id="profile-form" class="stack">
            <label class="field" for="account-username">
              <span>ユーザー名</span>
              <input
                id="account-username"
                type="text"
                name="username"
                autocomplete="username"
                required
              />
            </label>
            <div class="button-row align-start">
              <button type="submit" class="primary">変更を保存</button>
            </div>
          </form>
        </div>

        <div class="card">
          <header class="section-header">
            <div>
              <h2>パスキー</h2>
              <p class="hint">
                新しいデバイスを登録したり、不要な鍵を削除できます。
              </p>
            </div>
            <div class="section-actions">
              <button
                type="button"
                id="add-passkey"
                class="secondary accent"
              >
                別の鍵を追加
              </button>
            </div>
          </header>
          <ul id="credential-list" class="credentials">
            <li class="empty">パスキーを読み込んでいます…</li>
          </ul>
        </div>
      </section>
    </main>

    <dialog id="passkey-dialog">
      <form id="passkey-form" class="dialog-form">
        <h2>パスキーを追加</h2>
        <p class="hint">
          このデバイスの情報から自動的に名前を付けて保存します。
        </p>
        <div class="button-row align-end">
          <button type="button" id="cancel-passkey-dialog" class="secondary">
            キャンセル
          </button>
          <button type="submit" id="submit-passkey-dialog" class="primary">
            追加
          </button>
        </div>
      </form>
    </dialog>

    <div class="toast-region" aria-live="polite" aria-atomic="true">
      <div
        class="toast"
        id="status"
        data-status="info"
        data-visible="true"
        role="status"
      >
        準備が整いました。
      </div>
    </div>

    <script type="module">
      import { createClient } from "/webauthn/client.js";

      const client = createClient();

      const statusEl = document.getElementById("status");
      const accountView = document.getElementById("account-view");
      const accountSummary = document.getElementById("account-summary");
      const logoutButton = document.getElementById("logout");
      const deleteAccountButton = document.getElementById(
        "delete-account",
      );
      const profileForm = document.getElementById("profile-form");
      const accountUsernameInput = document.getElementById(
        "account-username",
      );
      const profileSubmitButton = profileForm.querySelector(
        'button[type="submit"]',
      );
      const addPasskeyButton = document.getElementById("add-passkey");
      const credentialsList = document.getElementById(
        "credential-list",
      );
      const passkeyDialog = document.getElementById("passkey-dialog");
      const passkeyForm = document.getElementById("passkey-form");
      const passkeyDialogCancel = document.getElementById(
        "cancel-passkey-dialog",
      );
      const passkeyDialogSubmit = document.getElementById(
        "submit-passkey-dialog",
      );

      const state = {
        account: null,
        credentials: [],
      };

      let statusHideTimeout = 0;
      let statusAnimationFrame = 0;

      const setStatus = (
        message,
        status = "info",
        { autoHide = false, timeout = 4000 } = {},
      ) => {
        statusEl.textContent = message;
        statusEl.dataset.status = status;
        statusEl.dataset.visible = "false";
        if (statusAnimationFrame) {
          cancelAnimationFrame(statusAnimationFrame);
        }
        if (statusHideTimeout) {
          clearTimeout(statusHideTimeout);
          statusHideTimeout = 0;
        }
        statusAnimationFrame = requestAnimationFrame(() => {
          statusAnimationFrame = 0;
          statusEl.dataset.visible = "true";
          if (autoHide) {
            statusHideTimeout = setTimeout(() => {
              statusHideTimeout = 0;
              statusEl.dataset.visible = "false";
            }, timeout);
          }
        });
      };

      const formatDate = (value) => {
        try {
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return "-";
          }
          return date.toLocaleString();
        } catch {
          return "-";
        }
      };

      const updateView = () => {
        accountView.hidden = !state.account;
      };

      const renderCredentials = (credentials) => {
        credentialsList.innerHTML = "";
        if (!state.account) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "サインインするとパスキーが表示されます。";
          credentialsList.append(li);
          return;
        }
        if (!credentials.length) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "まだパスキーが登録されていません。";
          credentialsList.append(li);
          return;
        }
        for (const credential of credentials) {
          const li = document.createElement("li");

          const header = document.createElement("div");
          header.className = "credential-header";
          const title = document.createElement("strong");
          title.textContent = credential.nickname ||
            "名前のないデバイス";
          header.append(title);

          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "link";
          deleteButton.dataset.credentialId = credential.id;
          deleteButton.textContent = "削除";
          header.append(deleteButton);

          const meta = document.createElement("dl");
          meta.className = "credential-meta";
          const addMetaRow = (label, value) => {
            const row = document.createElement("div");
            const labelEl = document.createElement("dt");
            labelEl.textContent = label;
            const valueEl = document.createElement("dd");
            valueEl.textContent = value;
            valueEl.style.fontWeight = "500";
            row.append(labelEl, valueEl);
            meta.append(row);
          };

          addMetaRow("登録日", formatDate(credential.createdAt));
          addMetaRow(
            "最終使用日",
            credential.lastUsedAt
              ? formatDate(credential.lastUsedAt)
              : "-",
          );

          li.append(header, meta);
          credentialsList.append(li);
        }
      };

      const renderAccount = () => {
        const account = state.account;
        if (!account) {
          accountSummary.textContent =
            "サインインしてアカウントを管理しましょう。";
          accountUsernameInput.value = "";
          renderCredentials([]);
          updateView();
          return;
        }
        const { user, credentials } = account;
        accountSummary.textContent = user.username;
        accountUsernameInput.value = user.username;
        renderCredentials(credentials);
        updateView();
      };

      const setAccount = (account) => {
        if (account && account.user) {
          state.account = {
            user: account.user,
            credentials: Array.isArray(account.credentials)
              ? account.credentials
              : [],
          };
          state.credentials = state.account.credentials;
        } else {
          state.account = null;
          state.credentials = [];
        }
        renderAccount();
      };

      const clearAccount = () => {
        setAccount(null);
      };

      const getSession = async () => {
        try {
          const response = await fetch("/session", {
            credentials: "include",
          });
          if (!response.ok) {
            return null;
          }
          return await response.json();
        } catch {
          return null;
        }
      };

      const extractErrorMessage = async (response) => {
        try {
          const json = await response.clone().json();
          if (json && typeof json === "object" && "message" in json) {
            const message = json.message;
            if (typeof message === "string" && message.trim()) {
              return message.trim();
            }
          }
        } catch {
          // ignore
        }
        try {
          const text = await response.text();
          if (text.trim()) {
            return text.trim();
          }
        } catch {
          // ignore
        }
        return `リクエストがステータス${response.status}で失敗しました`;
      };

      const fetchAccount = async (username) => {
        const normalized = username.trim();
        if (!normalized) {
          throw new Error("ユーザー名は必須です。");
        }
        const response = await fetch(
          `/webauthn/credentials?username=${
            encodeURIComponent(normalized)
          }`,
          { credentials: "include" },
        );
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error("アカウントが見つかりません。");
          }
          throw new Error(await extractErrorMessage(response));
        }
        const data = await response.json();
        if (!data || typeof data !== "object" || !data.user) {
          throw new Error("アカウントが見つかりません。");
        }
        const credentials = Array.isArray(data.credentials)
          ? data.credentials
          : [];
        return { user: data.user, credentials };
      };

      const loadAccount = async (username) => {
        const account = await fetchAccount(username);
        setAccount(account);
        return account;
      };

      const refreshAccount = async () => {
        if (!state.account) {
          return;
        }
        const username = state.account.user.username;
        try {
          await loadAccount(username);
        } catch (error) {
          setStatus(
            error.message ?? "アカウントを更新できません。",
            "error",
          );
        }
      };

      logoutButton.addEventListener("click", async () => {
        if (logoutButton.dataset.loading === "true") {
          return;
        }
        logoutButton.dataset.loading = "true";
        logoutButton.disabled = true;
        try {
          const response = await fetch("/session/logout", {
            method: "POST",
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          clearAccount();
          window.location.href = "/";
        } catch (error) {
          setStatus(
            error?.message
              ? `サインアウトに失敗しました: ${error.message}`
              : "サインアウトに失敗しました。",
            "error",
          );
        } finally {
          logoutButton.dataset.loading = "false";
          logoutButton.disabled = false;
        }
      });

      deleteAccountButton.addEventListener("click", async () => {
        if (!state.account) {
          setStatus(
            "アカウントを削除する前にサインインしてください。",
            "error",
          );
          return;
        }
        if (deleteAccountButton.dataset.loading === "true") {
          return;
        }
        const confirmed = window.confirm(
          "アカウントを削除するとすべてのパスキーが消えます。この操作は取り消せません。続行しますか？",
        );
        if (!confirmed) {
          return;
        }
        deleteAccountButton.dataset.loading = "true";
        deleteAccountButton.disabled = true;
        try {
          const response = await fetch("/account", {
            method: "DELETE",
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          clearAccount();
          window.location.href = "/";
        } catch (error) {
          setStatus(
            error?.message
              ? `アカウントの削除に失敗しました: ${error.message}`
              : "アカウントの削除に失敗しました。",
            "error",
          );
        } finally {
          deleteAccountButton.dataset.loading = "false";
          deleteAccountButton.disabled = false;
        }
      });

      addPasskeyButton.addEventListener("click", () => {
        if (!state.account) {
          setStatus(
            "新しいパスキーを追加する前にサインインしてください。",
            "error",
          );
          return;
        }
        try {
          passkeyDialog.showModal();
          passkeyDialogSubmit.focus();
        } catch (error) {
          console.error("Unable to open passkey dialog:", error);
        }
      });

      passkeyDialogCancel.addEventListener("click", () => {
        passkeyDialog.close();
      });

      passkeyDialog.addEventListener("close", () => {
        passkeyForm.dataset.loading = "false";
        passkeyDialogSubmit.disabled = false;
      });

      passkeyForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (passkeyForm.dataset.loading === "true") {
          return;
        }
        if (!state.account) {
          setStatus(
            "サインイン中のアカウントがありません。",
            "error",
          );
          return;
        }
        passkeyForm.dataset.loading = "true";
        passkeyDialogSubmit.disabled = true;
        try {
          setStatus("セキュリティキーの操作を待機しています…");
          const result = await client.register({
            username: state.account.user.username,
          });
          const nickname = result?.credential?.nickname?.trim();
          setStatus(
            nickname
              ? `パスキー「${nickname}」を追加しました。`
              : "パスキーを追加しました。",
            "success",
          );
          passkeyDialog.close();
          await refreshAccount();
        } catch (error) {
          let message = "パスキーの設定に失敗しました。";
          let statusType = "error";
          if (error instanceof DOMException) {
            switch (error.name) {
              case "NotAllowedError":
                message =
                  "このデバイスには既にこのアカウントのパスキーがあります。別の認証器を使用するか既存の鍵を削除してください。";
                break;
              case "InvalidStateError":
                message =
                  "この認証器は既にこのアカウントに登録されているため要求を拒否しました。";
                break;
              case "AbortError":
                message = "パスキーの設定がキャンセルされました。";
                statusType = "info";
                break;
              default:
                if (error.message?.trim()) {
                  message =
                    `パスキーの設定に失敗しました: ${error.message}`;
                }
                break;
            }
          } else if (error instanceof Error && error.message.trim()) {
            message = `パスキーの設定に失敗しました: ${error.message}`;
          }
          setStatus(message, statusType);
        } finally {
          passkeyDialogSubmit.disabled = false;
          passkeyForm.dataset.loading = "false";
        }
      });

      credentialsList.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const button = target.closest("button[data-credential-id]");
        if (!(button instanceof HTMLButtonElement)) {
          return;
        }
        if (!state.account) {
          setStatus(
            "パスキーを管理する前にサインインしてください。",
            "error",
          );
          return;
        }
        const credentialId = button.dataset.credentialId;
        if (!credentialId) {
          return;
        }
        if (button.dataset.loading === "true") {
          return;
        }
        button.dataset.loading = "true";
        button.disabled = true;
        try {
          setStatus("パスキーを削除しています…");
          await client.delete({
            username: state.account.user.username,
            credentialId,
          });
          setStatus("パスキーを削除しました。", "success");
          await refreshAccount();
        } catch (error) {
          setStatus(
            error?.message
              ? `パスキーの削除に失敗しました: ${error.message}`
              : "パスキーの削除に失敗しました。",
            "error",
          );
        } finally {
          button.dataset.loading = "false";
          button.disabled = false;
        }
      });

      profileForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!state.account) {
          setStatus(
            "プロフィールを更新する前にサインインしてください。",
            "error",
          );
          return;
        }
        if (profileForm.dataset.loading === "true") {
          return;
        }
        const username = accountUsernameInput.value.trim();
        const payload = {};
        if (username && username !== state.account.user.username) {
          payload.username = username;
        }
        if (Object.keys(payload).length === 0) {
          setStatus("保存する変更がありません。", "info");
          return;
        }
        profileForm.dataset.loading = "true";
        profileSubmitButton.disabled = true;
        try {
          const response = await fetch("/account", {
            method: "PATCH",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          const data = await response.json();
          if (!data || typeof data !== "object" || !data.user) {
            throw new Error("サーバーから予期しない応答がありました。");
          }
          state.account = {
            user: data.user,
            credentials: state.credentials,
          };
          renderAccount();
          setStatus("プロフィールを更新しました。", "success");
        } catch (error) {
          setStatus(
            error?.message
              ? `プロフィールの保存に失敗しました: ${error.message}`
              : "プロフィールの保存に失敗しました。",
            "error",
          );
        } finally {
          profileForm.dataset.loading = "false";
          profileSubmitButton.disabled = false;
        }
      });

      const initialise = async () => {
        setStatus("アカウント情報を読み込んでいます…");
        const session = await getSession();
        if (!session?.isAuthenticated || !session.user) {
          window.location.href = "/";
          return;
        }
        try {
          await loadAccount(session.user.username);
          setStatus("おかえりなさい。", "success", { autoHide: true });
        } catch (error) {
          console.error("Failed to restore session:", error);
          clearAccount();
          setStatus(
            "アカウント情報を取得できませんでした。もう一度サインインしてください。",
            "error",
          );
          window.location.href = "/";
        }
      };

      await initialise();

      statusEl.addEventListener("click", () => {
        if (statusHideTimeout) {
          clearTimeout(statusHideTimeout);
          statusHideTimeout = 0;
        }
        if (statusAnimationFrame) {
          cancelAnimationFrame(statusAnimationFrame);
          statusAnimationFrame = 0;
        }
        statusEl.dataset.visible = "false";
      });
    </script>
  </body>
</html>
