<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ID Central</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="page">
      <header class="page-header">
        <div class="brand">
          <h1 id="brand"></h1>
        </div>
        <div class="status" id="status" data-status="info" role="status">
          準備が整いました。
        </div>
      </header>

      <section id="guest-view" class="panel">
        <div class="card">
          <h2>パスキーでサインイン</h2>
          <form id="guest-form" class="stack" autocomplete="off">
            <label class="field" for="guest-username">
              <span>ユーザー名</span>
              <input
                id="guest-username"
                type="text"
                name="username"
                autocomplete="username webauthn"
                placeholder="例: your-name"
                required
              />
            </label>
            <div class="button-row align-start">
              <button type="submit" class="primary">サインイン</button>
              <button
                type="button"
                id="open-create-account"
                class="secondary"
              >
                アカウントを作成
              </button>
            </div>
          </form>
          <p id="conditional-status" class="hint" data-state="pending">
            パスキーの自動入力に対応しているか確認しています…
          </p>
        </div>
      </section>

      <section id="account-view" class="panel" hidden>
        <div class="card">
          <header class="section-header">
            <div>
              <h2>プロフィール情報</h2>
              <p class="hint" id="account-summary">
                サインイン中のユーザー情報が表示されます。
              </p>
            </div>
            <div class="section-actions">
              <button type="button" id="logout" class="secondary">
                ログアウト
              </button>
              <button type="button" id="delete-account" class="danger">
                アカウントを削除
              </button>
            </div>
          </header>
          <form id="profile-form" class="stack">
            <label class="field" for="account-username">
              <span>ユーザー名</span>
              <input
                id="account-username"
                type="text"
                name="username"
                autocomplete="username"
                required
              />
            </label>
            <label class="field" for="account-display-name">
              <span>表示名</span>
              <input
                id="account-display-name"
                type="text"
                name="displayName"
                autocomplete="name"
              />
            </label>
            <div class="button-row align-start">
              <button type="submit" class="primary">変更を保存</button>
            </div>
          </form>
        </div>

        <div class="card">
          <header class="section-header">
            <div>
              <h2>パスキー</h2>
              <p class="hint">
                新しいデバイスを登録したり、不要な鍵を削除できます。
              </p>
            </div>
            <div class="section-actions">
              <button
                type="button"
                id="add-passkey"
                class="secondary accent"
              >
                別の鍵を追加
              </button>
            </div>
          </header>
          <ul id="credential-list" class="credentials">
            <li class="empty">サインインするとパスキーが表示されます。</li>
          </ul>
        </div>
      </section>

      <dialog id="passkey-dialog">
        <form id="passkey-form" class="dialog-form">
          <h2 id="passkey-dialog-title">パスキーを追加</h2>
          <p id="passkey-dialog-description" class="hint">
            後から分かるように鍵に名前を付けてください。
          </p>
          <label class="field" id="passkey-display-name-field">
            <span>表示名</span>
            <input
              id="passkey-display-name"
              type="text"
              name="displayName"
              autocomplete="name"
            />
          </label>
          <label class="field" for="passkey-nickname">
            <span>パスキーのニックネーム</span>
            <input
              id="passkey-nickname"
              type="text"
              name="nickname"
              placeholder="仕事用ノートPC"
              required
            />
          </label>
          <div class="button-row align-end">
            <button type="button" id="cancel-passkey-dialog" class="secondary">
              キャンセル
            </button>
            <button type="submit" id="submit-passkey-dialog" class="primary">
              続行
            </button>
          </div>
        </form>
      </dialog>
    </main>

    <script type="module">
      import { createClient } from "/webauthn/client.js";

      const client = createClient();

      const storageKey = "passkeys.currentUsername";

      const statusEl = document.getElementById("status");
      const guestView = document.getElementById("guest-view");
      const accountView = document.getElementById("account-view");
      const guestForm = document.getElementById("guest-form");
      const guestUsernameInput = document.getElementById(
        "guest-username",
      );
      const conditionalStatus = document.getElementById(
        "conditional-status",
      );
      const createAccountButton = document.getElementById(
        "open-create-account",
      );
      const accountSummary = document.getElementById("account-summary");
      const logoutButton = document.getElementById("logout");
      const deleteAccountButton = document.getElementById(
        "delete-account",
      );
      const profileForm = document.getElementById("profile-form");
      const accountUsernameInput = document.getElementById(
        "account-username",
      );
      const accountDisplayNameInput = document.getElementById(
        "account-display-name",
      );
      const profileSubmitButton = profileForm.querySelector(
        'button[type="submit"]',
      );
      const addPasskeyButton = document.getElementById("add-passkey");
      const credentialsList = document.getElementById(
        "credential-list",
      );
      const passkeyDialog = document.getElementById("passkey-dialog");
      const passkeyForm = document.getElementById("passkey-form");
      const passkeyDialogTitle = document.getElementById(
        "passkey-dialog-title",
      );
      const passkeyDialogDescription = document.getElementById(
        "passkey-dialog-description",
      );
      const passkeyDisplayNameField = document.getElementById(
        "passkey-display-name-field",
      );
      const passkeyDisplayNameInput = document.getElementById(
        "passkey-display-name",
      );
      const passkeyNicknameInput = document.getElementById(
        "passkey-nickname",
      );
      const passkeyDialogCancel = document.getElementById(
        "cancel-passkey-dialog",
      );
      const passkeyDialogSubmit = document.getElementById(
        "submit-passkey-dialog",
      );

      const state = {
        account: null,
        credentials: [],
        conditionalAvailable: null,
      };

      const setStatus = (message, type = "info") => {
        statusEl.textContent = message;
        statusEl.dataset.status = type;
      };

      const formatDate = (value) => {
        try {
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) {
            return "-";
          }
          return date.toLocaleString();
        } catch {
          return "-";
        }
      };

      const storeUsername = (value) => {
        try {
          if (value) {
            localStorage.setItem(storageKey, value);
          }
        } catch {
          // ignore storage failures
        }
      };

      const getStoredUsername = () => {
        try {
          return localStorage.getItem(storageKey) ?? "";
        } catch {
          return "";
        }
      };

      const updateViews = () => {
        const hasAccount = Boolean(state.account);
        guestView.hidden = hasAccount;
        accountView.hidden = !hasAccount;
      };

      const renderCredentials = (credentials) => {
        credentialsList.innerHTML = "";
        if (!state.account) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "サインインするとパスキーが表示されます。";
          credentialsList.append(li);
          return;
        }
        if (!credentials.length) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "まだパスキーが登録されていません。";
          credentialsList.append(li);
          return;
        }
        for (const credential of credentials) {
          const li = document.createElement("li");

          const header = document.createElement("div");
          header.className = "credential-header";
          const title = document.createElement("strong");
          title.textContent = credential.nickname ||
            "名前のないデバイス";
          header.append(title);

          const deleteButton = document.createElement("button");
          deleteButton.type = "button";
          deleteButton.className = "danger outline";
          deleteButton.dataset.credentialId = credential.id;
          deleteButton.textContent = "削除";
          header.append(deleteButton);
          li.append(header);

          const meta = document.createElement("div");
          meta.className = "credential-meta";

          const rows = [
            ["デバイス", credential.deviceType ?? "不明"],
            ["バックアップ", credential.backedUp ? "はい" : "いいえ"],
            ["追加日", formatDate(credential.createdAt)],
            ["更新日", formatDate(credential.updatedAt)],
            [
              "ID",
              credential.id.length > 14
                ? `${credential.id.slice(0, 6)}…${
                  credential.id.slice(-6)
                }`
                : credential.id,
            ],
          ];

          for (const [label, value] of rows) {
            const row = document.createElement("div");
            const labelEl = document.createElement("span");
            labelEl.textContent = `${label}`;
            const valueEl = document.createElement("span");
            valueEl.textContent = `${value}`;
            valueEl.style.fontWeight = "500";
            row.append(labelEl, valueEl);
            meta.append(row);
          }

          li.append(meta);
          credentialsList.append(li);
        }
      };

      const renderAccount = () => {
        const account = state.account;
        if (!account) {
          accountSummary.textContent =
            "サインインしてアカウントを管理しましょう。";
          accountUsernameInput.value = "";
          accountDisplayNameInput.value = "";
          renderCredentials([]);
          updateViews();
          return;
        }
        const { user, credentials } = account;
        accountSummary.textContent = user.displayName
          ? `${user.displayName} · ${user.username}`
          : user.username;
        accountUsernameInput.value = user.username;
        accountDisplayNameInput.value = user.displayName ?? "";
        renderCredentials(credentials);
        updateViews();
      };

      const setAccount = (account) => {
        if (account && account.user) {
          state.account = {
            user: account.user,
            credentials: Array.isArray(account.credentials)
              ? account.credentials
              : [],
          };
          state.credentials = state.account.credentials;
        } else {
          state.account = null;
          state.credentials = [];
        }
        renderAccount();
      };

      const getSession = async () => {
        try {
          const response = await fetch("/session", {
            credentials: "include",
          });
          if (!response.ok) {
            return null;
          }
          return await response.json();
        } catch {
          return null;
        }
      };

      const extractErrorMessage = async (response) => {
        try {
          const json = await response.clone().json();
          if (json && typeof json === "object" && "message" in json) {
            const message = json.message;
            if (typeof message === "string" && message.trim()) {
              return message.trim();
            }
          }
        } catch {
          // ignore
        }
        try {
          const text = await response.text();
          if (text.trim()) {
            return text.trim();
          }
        } catch {
          // ignore
        }
        return `リクエストがステータス${response.status}で失敗しました`;
      };

      const fetchAccount = async (username) => {
        const normalized = username.trim();
        if (!normalized) {
          throw new Error("ユーザー名は必須です。");
        }
        const response = await fetch(
          `/webauthn/credentials?username=${
            encodeURIComponent(normalized)
          }`,
          { credentials: "include" },
        );
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error("アカウントが見つかりません。");
          }
          throw new Error(await extractErrorMessage(response));
        }
        const data = await response.json();
        if (!data || typeof data !== "object" || !data.user) {
          throw new Error("アカウントが見つかりません。");
        }
        const credentials = Array.isArray(data.credentials)
          ? data.credentials
          : [];
        return { user: data.user, credentials };
      };

      const loadAccount = async (username) => {
        const account = await fetchAccount(username);
        setAccount(account);
        storeUsername(account.user.username);
        return account;
      };

      const refreshAccount = async () => {
        if (!state.account) {
          return;
        }
        const username = state.account.user.username;
        try {
          await loadAccount(username);
        } catch (error) {
          setStatus(
            error.message ?? "アカウントを更新できません。",
            "error",
          );
        }
      };

      const clearAccount = () => {
        setAccount(null);
      };

      const authenticateWithPasskey = async (username) => {
        setStatus("パスキーの操作を待機しています…");
        await client.authenticate({ username });
        await loadAccount(username);
        setStatus("サインインに成功しました。", "success");
      };

      const checkConditionalMediation = async () => {
        if (
          typeof PublicKeyCredential === "undefined" ||
          typeof PublicKeyCredential.isConditionalMediationAvailable !==
            "function"
        ) {
          conditionalStatus.textContent =
            "ご利用のブラウザーはまだパスキーの自動入力に対応していません。";
          conditionalStatus.dataset.state = "unsupported";
          return false;
        }
        try {
          const available = await PublicKeyCredential
            .isConditionalMediationAvailable();
          state.conditionalAvailable = available;
          conditionalStatus.textContent = available
            ? "このブラウザーではパスキーの自動入力が利用できます。"
            : "パスキーの自動入力は無効です。手動でサインインできます。";
          conditionalStatus.dataset.state = available
            ? "available"
            : "absent";
          return available;
        } catch (error) {
          console.error(
            "Failed to detect conditional mediation:",
            error,
          );
          conditionalStatus.textContent =
            "パスキーの自動入力に対応しているか判定できませんでした。";
          conditionalStatus.dataset.state = "error";
          return false;
        }
      };

      guestForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (guestForm.dataset.loading === "true") {
          return;
        }
        const username = guestUsernameInput.value.trim();
        if (!username) {
          setStatus("先にユーザー名を入力してください。", "error");
          guestUsernameInput.focus();
          return;
        }
        guestForm.dataset.loading = "true";
        try {
          await authenticateWithPasskey(username);
        } catch (error) {
          setStatus(
            error?.message
              ? `サインインに失敗しました: ${error.message}`
              : "サインインがキャンセルされたか失敗しました。",
            "error",
          );
        } finally {
          guestForm.dataset.loading = "false";
        }
      });

      guestUsernameInput.addEventListener("input", () => {
        storeUsername(guestUsernameInput.value.trim());
      });

      const openPasskeyDialog = (mode) => {
        passkeyDialog.dataset.mode = mode;
        if (mode === "create") {
          passkeyDialogTitle.textContent = "アカウントを作成";
          passkeyDialogDescription.textContent =
            "このユーザー名に最初のパスキーを登録します。";
          passkeyDisplayNameField.hidden = false;
          passkeyDialogSubmit.textContent = "アカウントを作成";
          passkeyDisplayNameInput.value = guestUsernameInput.value
            .trim();
        } else {
          passkeyDialogTitle.textContent = "別のパスキーを追加";
          passkeyDialogDescription.textContent =
            "後から分かるように鍵に名前を付けてください。";
          passkeyDisplayNameField.hidden = true;
          passkeyDialogSubmit.textContent = "パスキーを保存";
          if (state.account?.user?.displayName) {
            passkeyDisplayNameInput.value =
              state.account.user.displayName;
          } else {
            passkeyDisplayNameInput.value = "";
          }
        }
        passkeyNicknameInput.value = "";
        try {
          passkeyDialog.showModal();
          passkeyNicknameInput.focus();
        } catch (error) {
          console.error("Unable to open dialog:", error);
        }
      };

      createAccountButton.addEventListener("click", () => {
        if (!guestUsernameInput.value.trim()) {
          setStatus(
            "アカウントを作成するにはユーザー名を入力してください。",
            "error",
          );
          guestUsernameInput.focus();
          return;
        }
        openPasskeyDialog("create");
      });

      addPasskeyButton.addEventListener("click", () => {
        if (!state.account) {
          setStatus(
            "新しいパスキーを追加する前にサインインしてください。",
            "error",
          );
          return;
        }
        openPasskeyDialog("add");
      });

      passkeyDialogCancel.addEventListener("click", () => {
        passkeyDialog.close();
      });

      passkeyDialog.addEventListener("close", () => {
        passkeyForm.dataset.loading = "false";
      });

      passkeyForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (passkeyForm.dataset.loading === "true") {
          return;
        }
        const nickname = passkeyNicknameInput.value.trim();
        if (!nickname) {
          setStatus(
            "パスキーのニックネームを入力してください。",
            "error",
          );
          passkeyNicknameInput.focus();
          return;
        }
        const mode = passkeyDialog.dataset.mode ?? "add";
        passkeyForm.dataset.loading = "true";
        passkeyDialogSubmit.disabled = true;
        try {
          if (mode === "create") {
            const username = guestUsernameInput.value.trim();
            if (!username) {
              throw new Error("ユーザー名は必須です。");
            }
            const displayName = passkeyDisplayNameInput.value.trim();
            setStatus("セキュリティキーの操作を待機しています…");
            await client.register({
              username,
              displayName: displayName || undefined,
              nickname,
            });
            setStatus(
              `パスキー「${nickname}」を登録しました。`,
              "success",
            );
            passkeyDialog.close();
            await authenticateWithPasskey(username);
          } else {
            if (!state.account) {
              throw new Error("サインイン中のアカウントがありません。");
            }
            const username = state.account.user.username;
            setStatus("セキュリティキーの操作を待機しています…");
            await client.register({
              username,
              displayName: state.account.user.displayName || undefined,
              nickname,
            });
            setStatus(
              `パスキー「${nickname}」を追加しました。`,
              "success",
            );
            passkeyDialog.close();
            await refreshAccount();
          }
        } catch (error) {
          let message = "パスキーの設定に失敗しました。";
          let statusType = "error";
          if (error instanceof DOMException) {
            switch (error.name) {
              case "NotAllowedError":
                message =
                  "このデバイスには既にこのアカウントのパスキーがあります。別の認証器を使用するか既存の鍵を削除してください。";
                break;
              case "InvalidStateError":
                message =
                  "この認証器は既にこのアカウントに登録されているため要求を拒否しました。";
                break;
              case "AbortError":
                message = "パスキーの設定がキャンセルされました。";
                statusType = "info";
                break;
              default:
                if (error.message?.trim()) {
                  message =
                    `パスキーの設定に失敗しました: ${error.message}`;
                }
                break;
            }
          } else if (error instanceof Error && error.message.trim()) {
            message = `パスキーの設定に失敗しました: ${error.message}`;
          }
          setStatus(message, statusType);
        } finally {
          passkeyDialogSubmit.disabled = false;
          passkeyForm.dataset.loading = "false";
        }
      });

      credentialsList.addEventListener("click", async (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const button = target.closest("button[data-credential-id]");
        if (!(button instanceof HTMLButtonElement)) {
          return;
        }
        if (!state.account) {
          setStatus(
            "パスキーを管理する前にサインインしてください。",
            "error",
          );
          return;
        }
        const credentialId = button.dataset.credentialId;
        if (!credentialId) {
          return;
        }
        if (button.dataset.loading === "true") {
          return;
        }
        button.dataset.loading = "true";
        button.disabled = true;
        try {
          setStatus("パスキーを削除しています…");
          await client.delete({
            username: state.account.user.username,
            credentialId,
          });
          setStatus("パスキーを削除しました。", "success");
          await refreshAccount();
        } catch (error) {
          setStatus(
            error?.message
              ? `パスキーの削除に失敗しました: ${error.message}`
              : "パスキーの削除に失敗しました。",
            "error",
          );
        } finally {
          button.dataset.loading = "false";
          button.disabled = false;
        }
      });

      profileForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        if (!state.account) {
          setStatus(
            "プロフィールを更新する前にサインインしてください。",
            "error",
          );
          return;
        }
        if (profileForm.dataset.loading === "true") {
          return;
        }
        const username = accountUsernameInput.value.trim();
        const displayName = accountDisplayNameInput.value.trim();
        const payload = {};
        if (username && username !== state.account.user.username) {
          payload.username = username;
        }
        if (displayName !== state.account.user.displayName) {
          payload.displayName = displayName;
        }
        if (Object.keys(payload).length === 0) {
          setStatus("保存する変更がありません。", "info");
          return;
        }
        profileForm.dataset.loading = "true";
        profileSubmitButton.disabled = true;
        try {
          const response = await fetch("/account", {
            method: "PATCH",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          const data = await response.json();
          if (!data || typeof data !== "object" || !data.user) {
            throw new Error("サーバーから予期しない応答がありました。");
          }
          state.account = {
            user: data.user,
            credentials: state.credentials,
          };
          storeUsername(data.user.username);
          renderAccount();
          setStatus("プロフィールを更新しました。", "success");
        } catch (error) {
          setStatus(
            error?.message
              ? `プロフィールの保存に失敗しました: ${error.message}`
              : "プロフィールの保存に失敗しました。",
            "error",
          );
        } finally {
          profileForm.dataset.loading = "false";
          profileSubmitButton.disabled = false;
        }
      });

      logoutButton.addEventListener("click", async () => {
        if (logoutButton.dataset.loading === "true") {
          return;
        }
        logoutButton.dataset.loading = "true";
        logoutButton.disabled = true;
        try {
          const response = await fetch("/session/logout", {
            method: "POST",
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          clearAccount();
          setStatus("サインアウトしました。", "info");
        } catch (error) {
          setStatus(
            error?.message
              ? `サインアウトに失敗しました: ${error.message}`
              : "サインアウトに失敗しました。",
            "error",
          );
        } finally {
          logoutButton.dataset.loading = "false";
          logoutButton.disabled = false;
        }
      });

      deleteAccountButton.addEventListener("click", async () => {
        if (!state.account) {
          setStatus(
            "アカウントを削除する前にサインインしてください。",
            "error",
          );
          return;
        }
        if (deleteAccountButton.dataset.loading === "true") {
          return;
        }
        const confirmed = window.confirm(
          "アカウントを削除するとすべてのパスキーが消えます。この操作は取り消せません。続行しますか？",
        );
        if (!confirmed) {
          return;
        }
        deleteAccountButton.dataset.loading = "true";
        deleteAccountButton.disabled = true;
        try {
          const response = await fetch("/account", {
            method: "DELETE",
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error(await extractErrorMessage(response));
          }
          clearAccount();
          setStatus("アカウントを削除しました。", "success");
        } catch (error) {
          setStatus(
            error?.message
              ? `アカウントの削除に失敗しました: ${error.message}`
              : "アカウントの削除に失敗しました。",
            "error",
          );
        } finally {
          deleteAccountButton.dataset.loading = "false";
          deleteAccountButton.disabled = false;
        }
      });

      const initialise = async () => {
        const stored = getStoredUsername();
        if (stored) {
          guestUsernameInput.value = stored;
        }
        await checkConditionalMediation();
        const session = await getSession();
        if (session?.isAuthenticated && session.user) {
          try {
            await loadAccount(session.user.username);
            setStatus("おかえりなさい。", "success");
            return;
          } catch (error) {
            console.error("Failed to restore session:", error);
            clearAccount();
            setStatus(
              "セッションを復元できませんでした。もう一度サインインしてください。",
              "error",
            );
            return;
          }
        }
        clearAccount();
        setStatus("準備が整いました。", "info");
      };

      await initialise();
    </script>
  </body>
</html>
